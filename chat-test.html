<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket Chat Test (Hybrid)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h2>ğŸ”¥ Burn Chuck ì±„íŒ… í…ŒìŠ¤íŠ¸ (HTTP ì „ì†¡ + Socket ìˆ˜ì‹ )</h2>

<div style="border: 2px solid red; padding: 10px; margin-bottom: 20px;">
    <label><strong>ğŸ”‘ Access Token (Bearer ì œì™¸í•˜ê³  ë¶™ì—¬ë„£ê¸°):</strong></label><br>
    <textarea id="accessToken" rows="3" cols="100" placeholder="eyJh... (ë¡œê·¸ì¸ í›„ ë°›ì€ í† í°ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”)"></textarea>
</div>

<div>
    <button onclick="connect()">ì—°ê²°í•˜ê¸° (Connect)</button>
    <button onclick="disconnect()" disabled id="disconnectBtn">ì—°ê²° ëŠê¸°</button>
</div>
<br>
<div>
    <label>ë°© ë²ˆí˜¸(Room ID): <input type="text" id="roomId" value="1"></label><br>
    <label>ë©”ì‹œì§€: <input type="text" id="message" value="ì•ˆë…•í•˜ì„¸ìš”!"></label>
    <button onclick="sendMessage()" id="sendBtn" disabled>ì „ì†¡ (HTTP POST)</button>
</div>

<h3>ë°›ì€ ë©”ì‹œì§€ (Socket Subscribe):</h3>
<ul id="messages"></ul>

<script>
    var stompClient = null;

    function connect() {
        var socket = new SockJS('http://localhost:8080/ws-stomp');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = false;

            var roomId = document.getElementById('roomId').value;

            stompClient.subscribe('/sub/chat/room/' + roomId, function (message) {
                // ë°›ì€ ë©”ì‹œì§€ ì²˜ë¦¬
                var body = JSON.parse(message.body);
                // ì„œë²„ ì‘ë‹µ êµ¬ì¡°(ChatMessageResponse)ì— ë§ì¶°ì„œ íŒŒì‹±
                showMessage(body);
            });

            alert("ì—°ê²° ì„±ê³µ!");
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        console.log("Disconnected");
        document.getElementById('sendBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = true;
    }

    function sendMessage() {
        var roomId = document.getElementById('roomId').value;
        var content = document.getElementById('message').value;
        // [ì¤‘ìš”] ì…ë ¥ì°½ì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        var token = document.getElementById('accessToken').value;

        if (!token) {
            alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        var payload = {
            'roomId': roomId,
            'content': content
        };

        fetch('http://localhost:8080/api/chat/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // [í•µì‹¬] í—¤ë”ì— í† í° ì¶”ê°€ (Bearer + ê³µë°± + í† í°)
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (response.ok) {
                    console.log('HTTP ì „ì†¡ ì„±ê³µ');
                    document.getElementById('message').value = '';
                } else if (response.status === 401) {
                    alert('ì¸ì¦ ì‹¤íŒ¨! í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì „ì†¡ ì‹¤íŒ¨: ' + response.status);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì„œë²„ ì—ëŸ¬ ë°œìƒ');
            });
    }

    function showMessage(message) {
        var ul = document.getElementById('messages');
        var li = document.createElement('li');
        // ChatMessageResponse í•„ë“œëª…: senderNickname, content, createdDatetime
        li.appendChild(document.createTextNode(
            "[" + message.senderNickname + "] : " + message.content + " (" + message.createdDatetime + ")"
        ));
        ul.appendChild(li);
    }
</script>
</body>
</html>